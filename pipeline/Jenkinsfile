pipeline {
  agent {
    docker {
      image 'node:20-alpine'
      args '-w $WORKSPACE'
    }
  }

  environment {
    S3_BUCKET = 'pcip-sdk-node.pcip.barte.com'
    AWS_REGION = 'us-east-1'
  }

  stages {
    stage('Build') {
      steps {
        sh 'npm install'
        sh 'npm run build'
        sh 'ls -l dist'
      }
    }

    stage('Deploy to S3') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'AWS_CREDENTIALS_PCI', usernameVariable: 'AWS_ACCESS_KEY_ID', passwordVariable: 'AWS_SECRET_ACCESS_KEY')]) {
          // instala o AWS CLI no container node:20-alpine e faz deploy
          sh '''
            apk add --no-cache python3 py3-pip
            pip3 install --upgrade awscli

            aws --version

            aws s3 rm s3://${S3_BUCKET} --recursive --region ${AWS_REGION}

            aws s3 cp dist/index.html s3://${S3_BUCKET}/ --region ${AWS_REGION}
            aws s3 cp dist/script.min.js s3://${S3_BUCKET}/ --region ${AWS_REGION}
            aws s3 cp dist/sdk.min.js s3://${S3_BUCKET}/ --region ${AWS_REGION}
          '''
        }
      }
    }
  }
}
